"use strict";var F=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ae=(e,t)=>{for(var n in t)F(e,n,{get:t[n],enumerable:!0})},ue=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of se(t))!oe.call(e,s)&&s!==n&&F(e,s,{get:()=>t[s],enumerable:!(i=re(t,s))||i.enumerable});return e};var le=e=>ue(F({},"__esModule",{value:!0}),e);var me={};ae(me,{default:()=>ie});module.exports=le(me);var d=require("@raycast/api"),ne=require("react");var D=require("react");var f=require("@raycast/api"),B=require("child_process"),v=require("crypto"),r=require("fs"),W=require("path");var y=e=>{let t=Math.floor(e/3600),n=String(Math.floor(e%3600/60)).padStart(2,"0"),i=String(Math.floor(e%60)).padStart(2,"0");return`${t===0?"":t+":"}${n}:${i}`};var E=e=>(e.d1=e.d1=="----"?void 0:e.d1,e.d2=e.d2=="----"?void 0:e.d2,Math.round((e.d1?new Date(e.d1):new Date).getTime()-(e.d2?new Date(e.d2):new Date).getTime())/1e3);var c=require("@raycast/api"),O=require("fs"),k=(e,t)=>(e==null||e.length==0||e.length==null)&&!["always","onlyWhenNotRunning"].includes(t.showMenuBarIconWhen),I=e=>{let t=(0,c.getPreferenceValues)();if(e.launchedFromMenuBar||t.closeWindowOnTimerStart){let n=e.isErr?"\u26A0\uFE0F":"\u{1F389}";return(0,c.showHUD)(`${n} ${e.msg}`),(0,c.popToRoot)()}else(0,c.showToast)({style:e.isErr?c.Toast.Style.Failure:c.Toast.Style.Success,title:e.msg})},x=async()=>{let e=c.environment.supportPath+"/ringContinuouslyWarningShown";if(!(0,c.getPreferenceValues)().ringContinuously||(0,O.existsSync)(e))return!0;let n=await(0,c.confirmAlert)({title:"Ring Continuously is enabled!",icon:c.Icon.Bell,message:'When the timer rings, you will need to use the "Stop Running Timer" command or stop the timer in the "Manage Timers" command to dismiss the sound. You can configure this in your Raycast settings.'});return n&&(0,O.writeFileSync)(e,""),n};var _=require("process"),S=f.environment.supportPath+"/customTimers.json",P=f.environment.supportPath+"/defaultPresetVisibles.json",A=e=>{try{(0,r.unlinkSync)(e)}catch(t){if(t instanceof Error&&!t.message.includes("ENOENT"))throw t}},N=(e=!1)=>{let t=(0,f.getPreferenceValues)();return parseFloat(t.volumeSetting)>5?(I({msg:"Timer alert volume should not be louder than 5 (it can get quite loud!)",launchedFromMenuBar:e,isErr:!0}),!1):!0};async function L({timeInSeconds:e,timerName:t="Untitled",launchedFromMenuBar:n=!1,selectedSound:i="default",skipRingContinuouslyWarning:s=!1}){if(!s&&!await x())return;let a=(f.environment.supportPath+"/"+new Date().toISOString()+"---"+e+".timer").replace(/:/g,"__"),l=(0,f.getPreferenceValues)();if(l.ringContinuously){let h=`${a}`.replace(".timer",".dismiss");(0,r.writeFileSync)(h,".dismiss file for Timers")}let C=U(a,t,e,i),w=(0,B.exec)(C,(h,u)=>{if(h){console.log(`error: ${h.message}`);return}if(u){console.log(`stderr: ${u}`);return}}),b={name:t,pid:w.pid,lastPaused:"---",pauseElapsed:0,selectedSound:i==="default"?l.selectedSound:i};(0,r.writeFileSync)(a,JSON.stringify(b)),I({msg:`Timer "${t}" started for ${y(e)}!`,launchedFromMenuBar:n,isErr:!1})}function U(e,t,n,i){let s=(0,f.getPreferenceValues)(),m=`${f.environment.assetsPath+"/"+(i==="default"?s.selectedSound:i)}`,a=[`sleep ${n}`];a.push(`if [ -f "${e}" ]; then osascript -e 'display notification "Timer \\"${t}\\" complete" with title "Ding!"'`);let l=s.selectedSound==="speak_timer_name"?`say ${t}`:`afplay "${m}" --volume ${s.volumeSetting.replace(",",".")}`;if(a.push(l),s.ringContinuously){let C=`${e}`.replace(".timer",".dismiss");a.push(`while [ -f "${C}" ]; do ${l}; done`)}return a.push(`rm "${e}"; else echo "Timer deleted"; fi`),a.join(" ; ")}function j(e){let t=f.environment.supportPath+"/"+e,n=t.replace(".timer",".dismiss");A(t),A(n)}function H(e,t){let n=f.environment.supportPath+"/"+e;(0,_.kill)(t);let i=(0,r.readFileSync)(n).toString(),s=JSON.parse(i);s.pid=void 0,s.lastPaused=new Date,(0,r.writeFileSync)(n,JSON.stringify(s))}function Y(e){let t=f.environment.supportPath+"/"+e.originalFile,n=U(t,e.name,e.timeLeft,e.selectedSound),i=(0,B.exec)(n),s=(0,r.readFileSync)(t).toString(),m=JSON.parse(s);m.pauseElapsed=m.pauseElapsed+E({d2:e.lastPaused}),m.lastPaused="---",m.pid=i.pid,(0,r.writeFileSync)(t,JSON.stringify(m))}function q(){let e=[];return(0,r.readdirSync)(f.environment.supportPath).forEach(n=>{if((0,W.extname)(n)==".timer"){let i={name:"",secondsSet:-99,timeLeft:-99,originalFile:n,timeEnds:new Date,pid:void 0,lastPaused:"---",pauseElapsed:0,selectedSound:"default"},s=(0,r.readFileSync)(f.environment.supportPath+"/"+n).toString();try{let l=JSON.parse(s);i.name=l.name,i.pid=l.pid,i.lastPaused=l.lastPaused,i.pauseElapsed=l.pauseElapsed,i.selectedSound=l.selectedSound}catch(l){if(!(l instanceof SyntaxError))throw l;i.name=s}let m=n.split("---");i.secondsSet=Number(m[1].split(".")[0]);let a=m[0].replace(/__/g,":");i.timeEnds=new Date(a),i.timeEnds.setSeconds(i.timeEnds.getSeconds()+i.secondsSet+i.pauseElapsed),i.timeLeft=Math.max(0,Math.round(i.pid===void 0?i.secondsSet-E({d1:i.lastPaused==="---"?void 0:i.lastPaused,d2:new Date(a)})+i.pauseElapsed:E({d1:i.timeEnds}))),e.push(i)}}),e.sort((n,i)=>n.timeLeft-i.timeLeft),e}function M(){(0,r.existsSync)(S)||(0,r.writeFileSync)(S,JSON.stringify({}))}function G(e){M();let t=JSON.parse((0,r.readFileSync)(S,"utf8"));t[(0,v.randomUUID)()]=e,(0,r.writeFileSync)(S,JSON.stringify(t))}function z(){M();let e=JSON.parse((0,r.readFileSync)(S,"utf8"));return Object.fromEntries(Object.entries(e).map(([t,n])=>n.showInMenuBar===void 0?[t,{...n,showInMenuBar:!0}]:[t,n]))}function K(e){M();let t=JSON.parse((0,r.readFileSync)(S,"utf8"));delete t[e],(0,r.writeFileSync)(S,JSON.stringify(t))}function Q(e){M();let t=JSON.parse((0,r.readFileSync)(S,"utf8")),n=t[e].showInMenuBar;t[e].showInMenuBar=n===void 0?!1:!n,(0,r.writeFileSync)(S,JSON.stringify(t))}var X=()=>{if(!(0,r.existsSync)(P)){let t={"2M":!0,"5M":!0,"10M":!0,"15M":!0,"30M":!0,"45M":!0,"60M":!0,"90M":!0};return(0,r.writeFileSync)(P,JSON.stringify(t)),t}return JSON.parse((0,r.readFileSync)(P,"utf8"))},Z=e=>{let t=JSON.parse((0,r.readFileSync)(P,"utf8"));t[e]=!t[e],(0,r.writeFileSync)(P,JSON.stringify(t))};var p=require("@raycast/api");function $(){let[e,t]=(0,D.useState)(void 0),[n,i]=(0,D.useState)({}),[s,m]=(0,D.useState)(e===void 0),a=()=>{M();let o=q();t(o);let g=z();i(g),m(!1)};return{timers:e,customTimers:n,isLoading:s,refreshTimers:a,handleStartTimer:o=>{N(o.launchedFromMenuBar)&&(L(o),a())},handlePauseTimer:o=>{if(o.pid==null&&o.lastPaused==="---")return(0,p.showToast)({style:p.Toast.Style.Failure,title:"This timer does not support pausing. Try restarting it to enable pausing."});H(o.originalFile,o.pid),a()},handleUnpauseTimer:o=>{if(o.pid==null&&o.lastPaused==="---")return(0,p.showToast)({style:p.Toast.Style.Failure,title:"This timer does not support pausing. Try restarting it to enable pausing."});Y(o),a()},handleStopTimer:o=>{t(e?.filter(g=>g.originalFile!==o.originalFile)),j(o.originalFile),a()},handleStartCT:({customTimer:o,launchedFromMenuBar:g})=>{N(g)&&(L({timeInSeconds:o.timeInSeconds,launchedFromMenuBar:g,timerName:o.name,selectedSound:o.selectedSound}),a())},handleCreateCT:o=>{let g={name:o.name,timeInSeconds:o.secondsSet,selectedSound:"default",showInMenuBar:!0};G(g),a()},handleDeleteCT:async o=>{let g={title:"Delete this preset?",icon:p.Icon.Trash,message:"You won't be able to recover it.",dismissAction:{title:"Cancel",style:p.Alert.ActionStyle.Cancel},primaryAction:{title:"Delete",style:p.Alert.ActionStyle.Destructive}};await(0,p.confirmAlert)(g)&&(K(o),a())},handleToggleCTVisibility:async o=>{Q(o),a()}}}var ee=(e,t)=>{if(e===void 0||e?.length===0||e.length==null)return;let n="timeLeft"in e[0]?e[0].timeLeft:e[0].timeElapsed;return t.showTitleInMenuBar?`${e[0].name}: ~${y(n)}`:`~${y(n)}`},te=(e,t,n)=>{switch(t.showMenuBarIconWhen){case"always":return n;case"never":return;case"onlyWhenRunning":return e!==void 0&&e?.length>0?n:void 0;case"onlyWhenNotRunning":return e===void 0||e?.length===0?n:void 0}};var V=require("react");function R(){let e=[{key:"2M",title:"2 Minute Timer",seconds:120},{key:"5M",title:"5 Minute Timer",seconds:300},{key:"10M",title:"10 Minute Timer",seconds:600},{key:"15M",title:"15 Minute Timer",seconds:900},{key:"30M",title:"30 Minute Timer",seconds:1800},{key:"45M",title:"45 Minute Timer",seconds:2700},{key:"60M",title:"60 Minute Timer",seconds:3600},{key:"90M",title:"90 Minute Timer",seconds:5400}],[t,n]=(0,V.useState)(),[i,s]=(0,V.useState)(t===void 0),m=()=>{n(X()),s(!1)};return{defaultPresets:e,defaultVisibles:t,isLoadingVisibles:i,refreshDefaultVisibles:m,handleDefaultPresetToggle:l=>{Z(l),m()}}}var T=require("react/jsx-runtime");function ie(){let{timers:e,customTimers:t,isLoading:n,refreshTimers:i,handleStartTimer:s,handleStopTimer:m,handleStartCT:a}=$(),{defaultPresets:l,defaultVisibles:C,refreshDefaultVisibles:w,isLoadingVisibles:b}=R();(0,ne.useEffect)(()=>{i(),w(),setInterval(()=>{i()},1e3)},[]),n&&i();let h=(0,d.getPreferenceValues)();return k(e,h)?null:(0,T.jsxs)(d.MenuBarExtra,{icon:te(e,h,d.Icon.Clock),isLoading:n&&b,title:ee(e,h),children:[(0,T.jsx)(d.MenuBarExtra.Item,{title:"Click running timer to stop"}),e?.map(u=>(0,T.jsx)(d.MenuBarExtra.Item,{title:u.name+": "+y(u.timeLeft)+" left",onAction:()=>m(u)},u.originalFile)),(0,T.jsx)(d.MenuBarExtra.Section,{children:Object.keys(t)?.sort((u,J)=>t[u].timeInSeconds-t[J].timeInSeconds).filter(u=>t[u].showInMenuBar).map(u=>(0,T.jsx)(d.MenuBarExtra.Item,{title:'Start "'+t[u].name+'"',onAction:()=>a({customTimer:t[u],launchedFromMenuBar:!0})},u))}),(0,T.jsx)(d.MenuBarExtra.Section,{children:l.filter(u=>C?.[u.key]).map(u=>(0,T.jsx)(d.MenuBarExtra.Item,{title:`Start ${u.title}`,onAction:()=>s({timeInSeconds:u.seconds,timerName:u.title,launchedFromMenuBar:!0})},u.key))}),(0,T.jsx)(d.MenuBarExtra.Section,{title:"Custom Timer",children:(0,T.jsx)(d.MenuBarExtra.Item,{title:"Start Custom Timer",onAction:async()=>await(0,d.launchCommand)({name:"startCustomTimer",type:d.LaunchType.UserInitiated})},"custom")})]})}
